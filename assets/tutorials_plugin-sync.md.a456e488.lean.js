import{_ as n,o as a,c as e,O as o}from"./chunks/framework.b2c12034.js";const l="/assets/sync-process.2c9ca871.png",t="/assets/ping-pong.1262802c.png",p="/assets/sync-screen.b314e6a9.png",c="/assets/sync-clients.8ef693f6.png",f=JSON.parse('{"title":"Using Plugins 2 - The sync Plugin","description":"","frontmatter":{},"headers":[],"relativePath":"tutorials/plugin-sync.md","filePath":"tutorials/plugin-sync.md"}'),r={name:"tutorials/plugin-sync.md"};function i(F,s,y,d,u,h){return a(),e("div",null,s[0]||(s[0]=[o('<h1 id="using-plugins-2-the-sync-plugin" tabindex="-1">Using Plugins 2 - The <em>sync</em> Plugin <a class="header-anchor" href="#using-plugins-2-the-sync-plugin" aria-label="Permalink to &quot;Using Plugins 2 - The _sync_ Plugin&quot;">‚Äã</a></h1><p>In this tutorial, we will dig into a very important problem when dealing with distributed system, and moreover in musical context, i.e. how to synchronize events across the different devices that compose our system.</p><p>After a short introduction about why this can be an issue and of the underlying concepts involved in synchronizing devices on a network, we will learn how to use the <a href="https://github.com/collective-soundworks/soundworks-plugin-sync" target="_blank" rel="noreferrer"><code>@soundworks/plugin-sync</code></a> plugin which is proposed to solve this particular class of problems.</p><blockquote><p>The final source code of this tutorial can be found <a href="https://github.com/collective-soundworks/tutorials/tree/main/plugin-sync" target="_blank" rel="noreferrer">here</a></p></blockquote><h3 id="related-documentation" tabindex="-1">Related documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related documentation&quot;">‚Äã</a></h3><ul><li><a href="https://github.com/collective-soundworks/soundworks-plugin-sync" target="_blank" rel="noreferrer">@soundworks/plugin-sync</a></li><li><a href="https://hal.science/hal-01304889v1" target="_blank" rel="noreferrer">Synchronisation for Distributed Audio Rendering over Heterogeneous Devices, in HTML5</a></li></ul><h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">‚Äã</a></h2><p>First of all let&#39;s start with a bit of theory to understand the general concepts and theory behind the <em>sync</em> plugin.</p><h3 id="the-why" tabindex="-1">The &quot;Why&quot; <a class="header-anchor" href="#the-why" aria-label="Permalink to &quot;The &quot;Why&quot;&quot;">‚Äã</a></h3><p>An important thing to understand when working with system composed of multiple devices is that each of them will live into a different timeline. Or to say it in a more formal way:</p><blockquote><p><em>¬´ An important observation is that, as a consequence of dealing with independent nodes, <strong>each one will have its own notion of time</strong>. In other words, we cannot assume that there is something like a global clock. This lack of a common reference of time leads to fundamental questions regarding the synchronization and coordination within a distributed system. ¬ª</em> Maarten van Steen, and Andrew S. Tanenbaum. ‚ÄúA Brief Introduction to Distributed Systems.‚Äù Computing 98, no. 10, October 2016.</p></blockquote><p>Indeed, each device has different physical clocks, each of them having a different time origin and furthermore a different speed. Most of the time, i.e. when we use our computers in our daily life, this is something we don&#39;t perceive as users, but only because our computers are constantly synchronizing themselves with reference clocks through the network thanks to the <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" target="_blank" rel="noreferrer">Network Time Protocol (NTP)</a>.</p><p>We could consider at this point that the problem is solved, i.e. let&#39;s use NTP! But unfortunately the problem is a bit more complicated in our context.</p><p>First, we cannot always assume that our devices will be connected to the Internet and thus able to connect to a NTP server. Indeed, in many situations, you will have to and/or want to create you own local network, and this, for several reasons: e.g. the venue where your artwork is presented has a poor network installation, you want to have some control over what happen on the network to make sure the bandwidth is properly used, etc.</p><p>Second, when you want to produce sounds in a synchronized way, the clocks that are of interest for you are not the <em>system clocks</em> but the <em>audio clocks</em>. Furthermore, we cannot assume that these two clocks, the system and the audio clocks, 1. share the same origin, e.g. the origin of <code>AudioContext.currentTime</code> is defined as when the context is resumed, and 2. that they even advance at the same speed, i.e. this is likely that the system and the sound card don&#39;t share the same physical clock.</p><p>For all these reason, it is important in our context to have some way of synchronizing <em>arbitrary clocks</em> without relying on external resources such as a NTP server.</p><h3 id="the-how" tabindex="-1">The &quot;How&quot; <a class="header-anchor" href="#the-how" aria-label="Permalink to &quot;The &quot;How&quot;&quot;">‚Äã</a></h3><p>On a more practical manner, we can thus consider that when trying to synchronize 2 clocks, we face a problem that can be expressed in the following form:</p><ul><li><strong>T<sub>clock1</sub> = a * T<sub>clock2</sub> + b</strong></li></ul><p>Where:</p><ul><li><em>a</em> is the speed difference between the two clocks, i.e. their <em>drift</em></li><li><em>b</em> is the origin offset, i.e. the delta time between their respective origin</li></ul><p>For the sake of keeping things simple, in this tutorial, we will consider the ideal case where 1. the respective speed of the clocks is exactly the same, i.e. <code>a = 1</code> and 2. the time of the propagation of a message on the network is constant (disclaimer, none of these assumptions are true in real life...). Hence, the goal will be to estimate <em>b</em> so that we can calculate <em>T<sub>clock1</sub></em> from <em>T<sub>clock2</sub></em> and inversely.</p><p>To achieve that, we need a clock that we consider as a reference, in our case the most simple is to use a clock provided by the server as all clients are connected to it. Then, as shown in the figure below, the clients will periodically ask the server for its current time, to calculate the offset of their respective clocks:</p><p><img src="'+l+'" alt="sync-process"></p><p>More precisely at each iteration:</p><ol><li>The client takes its current time (<em>t<sub>ping</sub></em>),</li><li>The client sends a message to the server which takes its time tag at message reception (<em>T<sub>ping</sub></em>)</li><li>Then, the server sends back a time tagged message to the client (<em>T<sub>pong</sub></em>)</li><li>The client takes its local time (<em>t<sub>pong</sub></em>) at reception of the message from the server.</li></ol><p><img src="'+t+`" alt="ping-pong"></p><p>Hence if we assume that the travel duration of the <em>ping</em> and <em>pong</em> messages are equal, we can compute the <em>offset</em> between the 2 clocks as the following:</p><ul><li>T<sub>reference</sub> = (T<sub>pong</sub> - T<sub>ping</sub>) / 2</li><li>t<sub>local</sub> = (t<sub>pong</sub> - t<sub>ping</sub>) / 2</li><li>offset = t<sub>local</sub> - T<sub>reference</sub></li></ul><p>From this point, it is then possible for all clients of our network to calculate a local estimation of the server clock. With such information, it therefore become possible for our clients to schedule audio or musical events in the same inferred time reference, while scheduling the actual audio synthesis in their own local audio time.</p><p>While this explanation is indeed simplified, we hope it gives you some intuition on the logic behind the synchronization process between different nodes on a network.</p><p>Let&#39;s now experiment with the <code>@soundworks/plugin-sync</code> to see how all these ideas translate into code.</p><h2 id="scaffolding-the-application" tabindex="-1">Scaffolding the application <a class="header-anchor" href="#scaffolding-the-application" aria-label="Permalink to &quot;Scaffolding the application&quot;">‚Äã</a></h2><p>First thing first, let&#39;s create a new project using the <em>soundworks</em> wizard:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">/path/to/working/directory</span></span>
<span class="line"><span style="color:#A6E22E;">npx</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">@soundworks/create@latest</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">plugin-sync</span></span></code></pre></div><p>When the wizard will ask you to select the plugins you would like to install, select the <code>@soundworks/plugin-platform-init</code> and the <code>@soundworks/plugin-sync</code>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki monokai"><code><span class="line"><span style="color:#56ADBC;"># Install plugins</span></span>
<span class="line"><span style="color:#56ADBC;">?</span><span style="color:#F8F8F2;"> </span><span style="color:#F8F8F2;font-weight:bold;">Select the plugins you would like to install/uninstall</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">‚Ä∫</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">- Space to select. Return to submit</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#86B42B;">‚óâ</span><span style="color:#F8F8F2;">   @soundworks/plugin-platform-init</span></span>
<span class="line"><span style="color:#86B42B;">‚óâ</span><span style="color:#F8F8F2;">   </span><span style="color:#56ADBC;text-decoration:underline;">@soundworks/plugin-sync</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   @soundworks/plugin-filesystem</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   @soundworks/plugin-scripting</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   @soundworks/plugin-checkin</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   @soundworks/plugin-position</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   @soundworks/plugin-logger</span></span></code></pre></div><p>And the <code>@ircam/sc-components</code> library:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki monokai"><code><span class="line"><span style="color:#56ADBC;"># Install libraries</span></span>
<span class="line"><span style="color:#56ADBC;">?</span><span style="color:#F8F8F2;"> </span><span style="color:#F8F8F2;font-weight:bold;">Select the libraries you would like to install/uninstall</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">‚Ä∫</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">- Space to select. Return to submit</span><span style="color:#F8F8F2;"> </span></span>
<span class="line"><span style="color:#86B42B;">‚óâ</span><span style="color:#F8F8F2;">   </span><span style="color:#56ADBC;text-decoration:underline;">@ircam/sc-components</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   @ircam/sc-scheduling</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   @ircam/sc-utils</span></span>
<span class="line"><span style="color:#F8F8F2;">‚óØ   node-web-audio-api</span></span></code></pre></div><p>Then, when the wizard will ask you for the configuration of the default client:</p><ul><li>Name it <code>player</code></li><li>Select the <code>browser</code> target</li><li>Select the <code>default</code> template</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki monokai"><code><span class="line"><span style="color:#56ADBC;"># Create client</span></span>
<span class="line"><span style="color:#86B42B;">‚úî</span><span style="color:#F8F8F2;"> </span><span style="color:#F8F8F2;font-weight:bold;">Name of your new client (lowercase, no-space):</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">‚Ä¶</span><span style="color:#F8F8F2;"> player</span></span>
<span class="line"><span style="color:#86B42B;">‚úî</span><span style="color:#F8F8F2;"> </span><span style="color:#F8F8F2;font-weight:bold;">Which runtime for your client?</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">‚Ä∫</span><span style="color:#F8F8F2;"> browser</span></span>
<span class="line"><span style="color:#86B42B;">‚úî</span><span style="color:#F8F8F2;"> </span><span style="color:#F8F8F2;font-weight:bold;">Which template would you like to use?</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">‚Ä∫</span><span style="color:#F8F8F2;"> default</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">- Creating client &quot;player&quot; in file &quot;src/clients/player.js&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">- name: </span><span style="color:#56ADBC;">player</span></span>
<span class="line"><span style="color:#F8F8F2;">- runtime: </span><span style="color:#56ADBC;">browser</span></span>
<span class="line"><span style="color:#F8F8F2;">- template: </span><span style="color:#56ADBC;">default</span></span>
<span class="line"><span style="color:#F8F8F2;">- default: </span><span style="color:#56ADBC;">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#56ADBC;">?</span><span style="color:#F8F8F2;"> </span><span style="color:#F8F8F2;font-weight:bold;">Confirm?</span><span style="color:#F8F8F2;"> </span><span style="color:#666666;">‚Ä∫</span><span style="color:#F8F8F2;"> no </span><span style="color:#666666;">/</span><span style="color:#F8F8F2;"> </span><span style="color:#56ADBC;text-decoration:underline;">yes</span></span></code></pre></div><p>Finally, open the new <code>plugin-sync</code> directory in your favorite editor and launch the application in development mode:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">plugin-sync</span></span>
<span class="line"><span style="color:#A6E22E;">npm</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">run</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">dev</span></span></code></pre></div><h2 id="using-the-sync-plugin" tabindex="-1">Using the <em>sync</em> plugin <a class="header-anchor" href="#using-the-sync-plugin" aria-label="Permalink to &quot;Using the _sync_ plugin&quot;">‚Äã</a></h2><h3 id="register-the-plugin" tabindex="-1">Register the plugin <a class="header-anchor" href="#register-the-plugin" aria-label="Permalink to &quot;Register the plugin&quot;">‚Äã</a></h3><p>Now that everything is ready let&#39;s start with installing our plugin both on the server and on the client side.</p><p>Open the <code>src/server.js</code> file and add the following code:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/server.js</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { Server } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/core/server.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { loadConfig, configureHttpRouter } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/helpers/server.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line diff add"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> ServerPluginSync </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/plugin-sync/server.js&#39;</span><span style="color:#F8F8F2;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> server </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">Server</span><span style="color:#F8F8F2;">(config);</span></span>
<span class="line"><span style="color:#A6E22E;">configureHttpRouter</span><span style="color:#F8F8F2;">(server);</span></span>
<span class="line diff add"><span style="color:#F8F8F2;">server.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">, ServerPluginSync); </span></span></code></pre></div><p>Then on the client-side, in the <code>src/clients/player.js</code>:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/clients/player.js</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { Client } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/core/client.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { loadConfig, launcher } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/helpers/browser.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line diff add"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> ClientPluginSync </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/plugin-sync/client.js&#39;</span><span style="color:#F8F8F2;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> client </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">Client</span><span style="color:#F8F8F2;">(config);</span></span>
<span class="line diff add"><span style="color:#F8F8F2;">client.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">, ClientPluginSync); </span></span></code></pre></div><p>If you launch a client, i.e. <a href="http://127.0.0.1:8000" target="_blank" rel="noreferrer">http://127.0.0.1:8000</a>, you should now see a screen telling you that the synchronizing process is on-going at startup:</p><p><img src="`+p+`" alt="sync-screen"></p><p>Finally, let&#39;s add a bit of code to display the current reference time as estimated by the client, alongside its local time:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/clients/player.js</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> client.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#88846F;">// retrieve the sync plugin instance</span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> sync </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> client.pluginManager.</span><span style="color:#A6E22E;">get</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">renderApp</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">render</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">html</span><span style="color:#E6DB74;">\`</span></span>
<span class="line"><span style="color:#E6DB74;">    &lt;div class=&quot;simple-layout&quot;&gt;</span></span>
<span class="line diff remove"><span style="color:#E6DB74;">      &lt;p&gt;Hello </span><span style="color:#F92672;">\${</span><span style="color:#F8F8F2;">client.config.app.name</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">!&lt;/p&gt; </span></span>
<span class="line diff add"><span style="color:#E6DB74;">      &lt;p&gt;localTime: </span><span style="color:#F92672;">\${</span><span style="color:#F8F8F2;">sync.</span><span style="color:#A6E22E;">getLocalTime</span><span style="color:#F8F8F2;">()</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">&lt;/p&gt; </span></span>
<span class="line diff add"><span style="color:#E6DB74;">      &lt;p&gt;syncTime: </span><span style="color:#F92672;">\${</span><span style="color:#F8F8F2;">sync.</span><span style="color:#A6E22E;">getSyncTime</span><span style="color:#F8F8F2;">()</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">&lt;/p&gt; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E6DB74;">      &lt;sw-credits .infos=&quot;</span><span style="color:#F92672;">\${</span><span style="color:#F8F8F2;">client.config.app</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">&quot;&gt;&lt;/sw-credits&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">    &lt;/div&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">  \`</span><span style="color:#F8F8F2;">, $container);</span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// refresh the screen at 60 fps </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  window.</span><span style="color:#A6E22E;">requestAnimationFrame</span><span style="color:#F8F8F2;">(renderApp); </span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">renderApp</span><span style="color:#F8F8F2;">();</span></span></code></pre></div><p>If you now open several browser windows side by side, you should see how the synchronization process allows to estimate a common reference clock (i.e. <code>syncTime</code>) alongside their own local clock (i.e. <code>localTime</code>):</p><p><img src="`+c+`" alt="sync-clients"></p><h2 id="synchronizing-the-audio-context" tabindex="-1">Synchronizing the audio context <a class="header-anchor" href="#synchronizing-the-audio-context" aria-label="Permalink to &quot;Synchronizing the audio context&quot;">‚Äã</a></h2><p>So far so good, but what we are interested in is to synchronize the clock of an <code>AudioContext</code> to synchronize our audio events.</p><p>By default, the <em>sync</em> plugin uses a default clock which is either <a href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Date/now" target="_blank" rel="noreferrer"><code>Date.now</code></a> or <a href="https://developer.mozilla.org/docs/Web/API/Performance/now" target="_blank" rel="noreferrer"><code>performance.now</code></a> depending on the runtime (i.e. browser or Node.js). However, it is indeed possible to configure it to use another clock, such as the one provided by <a href="https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/currentTime" target="_blank" rel="noreferrer"><code>AudioContext.currentTime</code></a>. Let&#39;s see how to implement that.</p><p>First, we will to setup the <code>@soundworks/plugin-platform-init</code> plugin which will allow us to resume the <code>AudioContext</code> and thus have a working clock. Indeed, if we used an <code>AudioContext</code> in default <code>suspended</code> state, the current time would always be zero, which would not be very useful for synchronizing...</p><p>Let&#39;s then add the following code in the <code>src/server.js</code> file:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/server.js</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { loadConfig, configureHttpRouter } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/helpers/server.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line diff add"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> ServerPluginPlatformInit </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/plugin-platform-init/server.js&#39;</span><span style="color:#F8F8F2;">; </span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> ServerPluginSync </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/plugin-sync/server.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// ...</span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#F8F8F2;">server.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;platform-init&#39;</span><span style="color:#F8F8F2;">, ServerPluginPlatformInit); </span></span>
<span class="line"><span style="color:#F8F8F2;">server.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">, ServerPluginSync);</span></span></code></pre></div><p>And the following on the client side, to resume our <code>AudioContext</code> when the user clicks on the screen:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/clients/player.js</span></span>
<span class="line diff add"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> ClientPluginPlatformInit </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/plugin-platform-init/client.js&#39;</span><span style="color:#F8F8F2;">; </span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> ClientPluginSync </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@soundworks/plugin-sync/client.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> client </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">Client</span><span style="color:#F8F8F2;">(config);</span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> audioContext </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">AudioContext</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#F8F8F2;">client.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;platform-init&#39;</span><span style="color:#F8F8F2;">, ClientPluginPlatformInit, { </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  audioContext, </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">}); </span></span>
<span class="line"><span style="color:#F8F8F2;">client.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">, ClientPluginSync);</span></span></code></pre></div><p>Finally, let configure further the <em>sync</em> plugin so that it uses the clock provided by the <code>AudioContext</code> and starts the synchronization process only when the audio context is properly resumed:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/clients/player.js</span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">client.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">, ClientPluginSync); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">client.pluginManager.</span><span style="color:#A6E22E;">register</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">, ClientPluginSync, { </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// use the audio context clock </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">getTimeFunction</span><span style="color:#F8F8F2;">: () </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> audioContext.currentTime, </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// declare the &#39;platform-init&#39; plugin as a dependency, so that the </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// sync process starts only when the audio context is resumed </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">}, [</span><span style="color:#E6DB74;">&#39;platform-init&#39;</span><span style="color:#F8F8F2;">]); </span></span></code></pre></div><p>And that&#39;s all, we now have a synchronization process estimating the server reference time using the clock provided by our audio context.</p><h2 id="trigger-a-synchronized-audio-event" tabindex="-1">Trigger a synchronized audio event <a class="header-anchor" href="#trigger-a-synchronized-audio-event" aria-label="Permalink to &quot;Trigger a synchronized audio event&quot;">‚Äã</a></h2><p>Now that everything is set up, let&#39;s just trigger some synchronized sound between all our <code>player</code> clients. The general idea will be that anytime a user clicks on a button, a sound will be played back in a synchronized manner on all clients 0.5 second after the click.</p><p>To that end, let&#39;s first create a shared state to propagate the synchronized time at which the sound should be played:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/server.js</span></span>
<span class="line diff add"><span style="color:#F8F8F2;">server.stateManager.</span><span style="color:#A6E22E;">defineClass</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;global&#39;</span><span style="color:#F8F8F2;">, { </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  triggerTime: { </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    type: </span><span style="color:#E6DB74;">&#39;float&#39;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    event: </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">, </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  }, </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">}); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> server.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">();</span></span>
<span class="line diff add"><span style="color:#88846F;">// create a global state on which all clients will attach </span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> _ </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> server.stateManager.</span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;global&#39;</span><span style="color:#F8F8F2;">); </span></span></code></pre></div><p>Then in our <code>player</code> clients, let&#39;s import a button component and attach to this state:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/clients/player.js</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { html, render } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;lit&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line diff add"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">&#39;@ircam/sc-components/sc-button.js&#39;</span><span style="color:#F8F8F2;">; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> client.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">();</span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> global </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> client.stateManager.</span><span style="color:#A6E22E;">attach</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;global&#39;</span><span style="color:#F8F8F2;">); </span></span></code></pre></div><p>Now let&#39;s update our interface so that when the user click the button, the <code>global</code> shared state is updated with the current sync time to which we add our offset of 0.5 seconds:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/clients/player.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">renderApp</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">render</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">html</span><span style="color:#E6DB74;">\`</span></span>
<span class="line"><span style="color:#E6DB74;">    &lt;div class=&quot;simple-layout&quot;&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">      &lt;p&gt;localTime: </span><span style="color:#F92672;">\${</span><span style="color:#F8F8F2;">sync.</span><span style="color:#A6E22E;">getLocalTime</span><span style="color:#F8F8F2;">()</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">      &lt;p&gt;syncTime: </span><span style="color:#F92672;">\${</span><span style="color:#F8F8F2;">sync.</span><span style="color:#A6E22E;">getSyncTime</span><span style="color:#F8F8F2;">()</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">&lt;/p&gt;</span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#E6DB74;">      &lt;sc-button </span></span>
<span class="line diff add"><span style="color:#E6DB74;">        @input=</span><span style="color:#F92672;">\${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> global.</span><span style="color:#A6E22E;">set</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;triggerTime&#39;</span><span style="color:#F8F8F2;">, sync.</span><span style="color:#A6E22E;">getSyncTime</span><span style="color:#F8F8F2;">() </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.5</span><span style="color:#F8F8F2;">)</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;"> </span></span>
<span class="line diff add"><span style="color:#E6DB74;">      &gt;trigger sound&lt;/sc-button&gt; </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E6DB74;">      &lt;sw-credits .infos=&quot;</span><span style="color:#F92672;">\${</span><span style="color:#F8F8F2;">client.config.app</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">&quot;&gt;&lt;/sw-credits&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">    &lt;/div&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">  \`</span><span style="color:#F8F8F2;">, $container);</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// ...</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>Finally, let&#39;s react to the update of the global state to trigger a sound at the given synchronized time. The main idea will be to convert the synchronized time into the local audio time to trigger the sound at the right moment.</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff"><code><span class="line"><span style="color:#88846F;">// src/clients/player.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> global </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> client.stateManager.</span><span style="color:#A6E22E;">attach</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;global&#39;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> sync </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> client.pluginManager.</span><span style="color:#A6E22E;">get</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;sync&#39;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#F8F8F2;">global.</span><span style="color:#A6E22E;">onUpdate</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">updates</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> { </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#E6DB74;">&#39;triggerTime&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">in</span><span style="color:#F8F8F2;"> updates) { </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// trigger time is in the synchronized timeline </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> syncTime </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> updates.triggerTime; </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// convert this time to the local audio timeline </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> audioTime </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> sync.</span><span style="color:#A6E22E;">getLocalTime</span><span style="color:#F8F8F2;">(syncTime); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// let&#39;s now trigger a random frequency at this exact moment </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> frequency </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">200</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> Math.</span><span style="color:#A6E22E;">random</span><span style="color:#F8F8F2;">() </span><span style="color:#F92672;">*</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">400</span><span style="color:#F8F8F2;">; </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> osc </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">OscillatorNode</span><span style="color:#F8F8F2;">(audioContext, { frequency }); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    osc.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    osc.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(audioTime); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    osc.</span><span style="color:#A6E22E;">stop</span><span style="color:#F8F8F2;">(audioTime </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.1</span><span style="color:#F8F8F2;">); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">  } </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">}); </span></span></code></pre></div><p>And tada! If you now open several clients at once, e.g. <a href="http://127.0.0.1:8000/?emulate=3" target="_blank" rel="noreferrer">http://127.0.0.1:8000/?emulate=3</a>, and click on a button, you should ear the different oscillators playing all together (with a nice dirty click at the end due to the lack of envelop üòÉ).</p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">‚Äã</a></h2><p>In this tutorial, you have learned the reasons and general concepts behind clock synchronization in a distributed system, and learned how to use the <em>sync</em> plugin provided by <em>soundworks</em> to synchronize audio events.</p><p>In the next tutorial, we will go further and use this new tool in a more musical way by implementing a distributed step sequencer.</p>`,82)]))}const m=n(r,[["render",i]]);export{f as __pageData,m as default};
